package decoder

import (
	"fmt"
	"testing"
)

var (
	sentences = [][]byte{
		[]byte("$GPRMC,190927.868,V,8323.821,S,05939.942,W,26.4,5.15,060113,,E*50"),
		[]byte("$GPGGA,190928.868,8323.821,S,05939.942,W,0,00,,,M,,M,,*49"),
		[]byte("$GPGLL,8323.821,S,05939.942,W,190929.868,V*28"),
		[]byte("$GPVTG,5.15,T,,M,26.4,N,48.8,K*55"),
		[]byte("$GPRMC,190931.868,V,5230.989,N,02133.667,W,75.3,27.65,060113,,E*7C"),
		[]byte("$GPGGA,190932.868,5230.989,N,02133.667,W,0,00,,,M,,M,,*5F"),
		[]byte("$GPGLL,5230.989,N,02133.667,W,190933.868,V*3E"),
		[]byte("$GPVTG,27.65,T,,M,75.3,N,139.5,K*59"),
		[]byte("$GPRMC,190935.868,V,7624.259,N,14937.538,W,5.6,38.01,060113,,E*41"),
		[]byte("$GPGGA,190936.868,7624.259,N,14937.538,W,0,00,,,M,,M,,*5C"),
		[]byte("$GPGLL,7624.259,N,14937.538,W,190937.868,V*3D"),
		[]byte("$GPVTG,38.01,T,,M,5.6,N,10.4,K*5C"),
		[]byte("$GPRMC,190939.868,V,1205.536,N,14430.326,W,16.3,31.36,060113,,E*7B"),
		[]byte("$GPGGA,190940.868,1205.536,N,14430.326,W,0,00,,,M,,M,,*51"),
		[]byte("$GPGLL,1205.536,N,14430.326,W,190941.868,V*30"),
		[]byte("$GPVTG,31.36,T,,M,16.3,N,30.1,K*61"),
		[]byte("$GPRMC,190943.868,V,0240.690,N,02422.688,W,51.8,36.41,060113,,E*73"),
		[]byte("$GPGGA,190944.868,0240.690,N,02422.688,W,0,00,,,M,,M,,*5F"),
		[]byte("$GPGLL,0240.690,N,02422.688,W,190945.868,V*3E"),
		[]byte("$GPVTG,36.41,T,,M,51.8,N,96.0,K*63"),
		[]byte("$GPRMC,190947.868,V,1825.847,N,07352.266,W,61.9,7.98,060113,,E*4E"),
		[]byte("$GPGGA,190948.868,1825.847,N,07352.266,W,0,00,,,M,,M,,*5E"),
		[]byte("$GPGLL,1825.847,N,07352.266,W,190949.868,V*3F"),
		[]byte("$GPVTG,7.98,T,,M,61.9,N,114.7,K*6B"),
		[]byte("$GPRMC,190951.868,V,5718.078,S,14817.441,E,33.0,42.06,060113,,E*74"),
		[]byte("$GPGGA,190952.868,5718.078,S,14817.441,E,0,00,,,M,,M,,*50"),
		[]byte("$GPGLL,5718.078,S,14817.441,E,190953.868,V*31"),
		[]byte("$GPVTG,42.06,T,,M,33.0,N,61.2,K*65"),
		[]byte("$GPRMC,190955.868,V,2002.959,N,10446.910,E,13.5,35.30,060113,,E*6B"),
		[]byte("$GPGGA,190956.868,2002.959,N,10446.910,E,0,00,,,M,,M,,*4D"),
		[]byte("$GPGLL,2002.959,N,10446.910,E,190957.868,V*2C"),
		[]byte("$GPVTG,35.30,T,,M,13.5,N,25.0,K*65"),
		[]byte("$GPRMC,190959.868,V,1112.864,S,11650.226,W,67.1,41.68,060113,,E*67"),
		[]byte("$GPGGA,191000.868,1112.864,S,11650.226,W,0,00,,,M,,M,,*4F"),
		[]byte("$GPGLL,1112.864,S,11650.226,W,191001.868,V*2E"),
		[]byte("$GPVTG,41.68,T,,M,67.1,N,124.3,K*5F"),
		[]byte("$GPRMC,191003.868,V,3645.163,N,02208.646,E,53.4,6.68,060113,,E*5E"),
		[]byte("$GPGGA,191004.868,3645.163,N,02208.646,E,0,00,,,M,,M,,*44"),
		[]byte("$GPGLL,3645.163,N,02208.646,E,191005.868,V*25"),
		[]byte("$GPVTG,6.68,T,,M,53.4,N,99.0,K*5A"),
		[]byte("$GPRMC,191007.868,V,7521.274,S,11544.558,E,33.3,1.60,060113,,E*48"),
		[]byte("$GPGGA,191008.868,7521.274,S,11544.558,E,0,00,,,M,,M,,*54"),
		[]byte("$GPGLL,7521.274,S,11544.558,E,191009.868,V*35"),
		[]byte("$GPVTG,1.60,T,,M,33.3,N,61.7,K*54"),
		[]byte("$GPRMC,191011.868,V,3937.741,N,13048.109,E,13.1,16.23,060113,,E*64"),
		[]byte("$GPGGA,191012.868,3937.741,N,13048.109,E,0,00,,,M,,M,,*45"),
		[]byte("$GPGLL,3937.741,N,13048.109,E,191013.868,V*24"),
		[]byte("$GPVTG,16.23,T,,M,13.1,N,24.3,K*60"),
		[]byte("$GPRMC,191015.868,V,5159.072,S,12900.432,W,27.1,18.28,060113,,E*65"),
		[]byte("$GPGGA,191016.868,5159.072,S,12900.432,W,0,00,,,M,,M,,*46"),
		[]byte("$GPGLL,5159.072,S,12900.432,W,191017.868,V*27"),
		[]byte("$GPVTG,18.28,T,,M,27.1,N,50.2,K*60"),
		[]byte("$GPRMC,191019.868,V,3915.493,S,02029.684,W,55.5,32.93,060113,,E*61"),
		[]byte("$GPGGA,191020.868,3915.493,S,02029.684,W,0,00,,,M,,M,,*42"),
		[]byte("$GPGLL,3915.493,S,02029.684,W,191021.868,V*23"),
		[]byte("$GPVTG,32.93,T,,M,55.5,N,102.7,K*5A"),
		[]byte("$GPRMC,191023.868,V,7427.886,S,02946.454,W,20.3,11.63,060113,,E*6D"),
		[]byte("$GPGGA,191024.868,7427.886,S,02946.454,W,0,00,,,M,,M,,*49"),
		[]byte("$GPGLL,7427.886,S,02946.454,W,191025.868,V*28"),
		[]byte("$GPVTG,11.63,T,,M,20.3,N,37.5,K*65"),
		[]byte("$GPRMC,191027.868,V,5722.266,N,01355.385,W,82.3,21.28,060113,,E*70"),
		[]byte("$GPGGA,191028.868,5722.266,N,01355.385,W,0,00,,,M,,M,,*58"),
		[]byte("$GPGLL,5722.266,N,01355.385,W,191029.868,V*39"),
		[]byte("$GPVTG,21.28,T,,M,82.3,N,152.5,K*53"),
		[]byte("$GPRMC,191031.868,V,4103.714,S,10416.130,E,66.9,29.74,060113,,E*71"),
		[]byte("$GPGGA,191032.868,4103.714,S,10416.130,E,0,00,,,M,,M,,*54"),
		[]byte("$GPGLL,4103.714,S,10416.130,E,191033.868,V*35"),
		[]byte("$GPVTG,29.74,T,,M,66.9,N,123.9,K*58"),
		[]byte("$GPRMC,191035.868,V,4727.456,S,14237.052,E,13.5,32.76,060113,,E*72"),
		[]byte("$GPGGA,191036.868,4727.456,S,14237.052,E,0,00,,,M,,M,,*51"),
		[]byte("$GPGLL,4727.456,S,14237.052,E,191037.868,V*30"),
		[]byte("$GPVTG,32.76,T,,M,13.5,N,25.1,K*61"),
		[]byte("$GPRMC,191039.868,V,2326.460,S,17256.818,E,98.8,9.60,060113,,E*4B"),
		[]byte("$GPGGA,191040.868,2326.460,S,17256.818,E,0,00,,,M,,M,,*54"),
		[]byte("$GPGLL,2326.460,S,17256.818,E,191041.868,V*35"),
		[]byte("$GPVTG,9.60,T,,M,98.8,N,182.9,K*64"),
		[]byte("$GPRMC,191043.868,V,1504.969,N,08302.401,W,31.4,8.63,060113,,E*4F"),
		[]byte("$GPGGA,191044.868,1504.969,N,08302.401,W,0,00,,,M,,M,,*54"),
		[]byte("$GPGLL,1504.969,N,08302.401,W,191045.868,V*35"),
		[]byte("$GPVTG,8.63,T,,M,31.4,N,58.2,K*54"),
		[]byte("$GPRMC,191047.868,V,8433.428,N,16150.273,W,79.3,26.09,060113,,E*7D"),
		[]byte("$GPGGA,191048.868,8433.428,N,16150.273,W,0,00,,,M,,M,,*55"),
		[]byte("$GPGLL,8433.428,N,16150.273,W,191049.868,V*34"),
		[]byte("$GPVTG,26.09,T,,M,79.3,N,146.9,K*5A"),
		[]byte("$GPRMC,191051.868,V,4108.770,N,05725.792,W,34.1,40.21,060113,,E*78"),
		[]byte("$GPGGA,191052.868,4108.770,N,05725.792,W,0,00,,,M,,M,,*5D"),
		[]byte("$GPGLL,4108.770,N,05725.792,W,191053.868,V*3C"),
		[]byte("$GPVTG,40.21,T,,M,34.1,N,63.2,K*66"),
		[]byte("$GPRMC,191055.868,V,7902.829,N,13751.479,E,50.9,21.38,060113,,E*6B"),
		[]byte("$GPGGA,191056.868,7902.829,N,13751.479,E,0,00,,,M,,M,,*4B"),
		[]byte("$GPGLL,7902.829,N,13751.479,E,191057.868,V*2A"),
		[]byte("$GPVTG,21.38,T,,M,50.9,N,94.3,K*6A"),
		[]byte("$GPRMC,191059.868,V,4018.964,S,00035.845,E,68.7,0.13,060113,,E*48"),
		[]byte("$GPGGA,191100.868,4018.964,S,00035.845,E,0,00,,,M,,M,,*59"),
		[]byte("$GPGLL,4018.964,S,00035.845,E,191101.868,V*38"),
		[]byte("$GPVTG,0.13,T,,M,68.7,N,127.2,K*6D"),
		[]byte("$GPRMC,191103.868,V,6448.776,N,08709.319,W,24.6,26.62,060113,,E*7E"),
		[]byte("$GPGGA,191104.868,6448.776,N,08709.319,W,0,00,,,M,,M,,*5E"),
		[]byte("$GPGLL,6448.776,N,08709.319,W,191105.868,V*3F"),
		[]byte("$GPVTG,26.62,T,,M,24.6,N,45.6,K*67"),
		[]byte("$GPRMC,191107.868,V,0520.643,S,16137.424,W,46.5,40.74,060113,,E*64"),
		[]byte("$GPGGA,191108.868,0520.643,S,16137.424,W,0,00,,,M,,M,,*4C"),
		[]byte("$GPGLL,0520.643,S,16137.424,W,191109.868,V*2D"),
		[]byte("$GPVTG,40.74,T,,M,46.5,N,86.0,K*6E"),
		[]byte("$GPRMC,191111.868,V,0742.362,N,15242.772,W,42.6,3.30,060113,,E*4C"),
		[]byte("$GPGGA,191112.868,0742.362,N,15242.772,W,0,00,,,M,,M,,*58"),
		[]byte("$GPGLL,0742.362,N,15242.772,W,191113.868,V*39"),
		[]byte("$GPVTG,3.30,T,,M,42.6,N,78.9,K*56"),
		[]byte("$GPRMC,191115.868,V,2833.745,S,07404.930,W,46.3,37.51,060113,,E*61"),
		[]byte("$GPGGA,191116.868,2833.745,S,07404.930,W,0,00,,,M,,M,,*44"),
		[]byte("$GPGLL,2833.745,S,07404.930,W,191117.868,V*25"),
		[]byte("$GPVTG,37.51,T,,M,46.3,N,85.7,K*6B"),
		[]byte("$GPRMC,191119.868,V,8803.738,S,09801.421,E,20.8,22.12,060113,,E*7E"),
		[]byte("$GPGGA,191120.868,8803.738,S,09801.421,E,0,00,,,M,,M,,*5A"),
		[]byte("$GPGLL,8803.738,S,09801.421,E,191121.868,V*3B"),
		[]byte("$GPVTG,22.12,T,,M,20.8,N,38.5,K*67"),
		[]byte("$GPRMC,191123.868,V,4609.142,S,17046.720,W,13.3,2.75,060113,,E*58"),
		[]byte("$GPGGA,191124.868,4609.142,S,17046.720,W,0,00,,,M,,M,,*49"),
		[]byte("$GPGLL,4609.142,S,17046.720,W,191125.868,V*28"),
		[]byte("$GPVTG,2.75,T,,M,13.3,N,24.5,K*52"),
	}
	invalid = [][]byte{
		[]byte("$GPRMC,191123.868,V,4609.142,S,17046.720,W,13.3,2.75,060113,,E*57"),
		[]byte("$GPGGA,191124.868,4609.142,S,17046.720,W,0,00,,,M,,M,,*A9"),
		[]byte("$GPGLL,4609.142,S,17046.720,W,191125.868,V*FF"),
		[]byte("$GPVTG,2.75,T,,M,13.3,N,24.5,K*00"),
	}
)

func TestChecksum(t *testing.T) {
	for _, sentence := range sentences {
		s, c, _ := Split(sentence)
		sum := Checksum(s)
		if c != sum {
			t.Errorf("Checksum mismatch. Expect: %0X Got: %0X", c, sum)
		}
	}
}

func TestDecode(t *testing.T) {
	for _, s := range sentences {
		m, err := Decode(s)
		if err != nil {
			t.Error(err)
		}
		t.Log(m)
	}
}

func TestInvalidChecksum(t *testing.T) {
	for _, s := range invalid {
		if ValidChecksum(s) {
			t.Errorf("Expected invalid checksum on %s", s)
		}
	}
}

func TestSplit(t *testing.T) {
	for _, sentence := range sentences {
		s, c, _ := Split(sentence)
		rebuilt := fmt.Sprintf("$%s*%0X", s, c)
		if string(sentence) != rebuilt {
			t.Errorf("Rebuild failed. Expect %s Got: %s", sentence, rebuilt)
		}
	}
}

func TestValidChecksum(t *testing.T) {
	for _, s := range sentences {
		if !ValidChecksum(s) {
			t.Errorf("Invalid checksum on %s", s)
		}
	}
}
